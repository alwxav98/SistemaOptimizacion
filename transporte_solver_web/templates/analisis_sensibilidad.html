<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Sensibilidad</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="d-flex align-items-center justify-content-center min-vh-100 overflow-auto">
    <div class="container mt-4">
        <div class="card p-4 shadow-lg overflow-auto">
            <h2 class="text-center text-primary">üìä An√°lisis de Sensibilidad</h2>

            <h4>Contexto del Problema:</h4>
            <textarea id="contexto" class="form-control mb-3" rows="4" placeholder="Ejemplo: Una empresa produce un √∫nico art√≠culo en tres plantas..."></textarea>

            <h4>Resultado del Problema:</h4>
            <div class="alert alert-info" id="solucion" data-json='{{ solucion | tojson | safe }}'></div>

            <h4>Costo Total:</h4>
            <div class="alert alert-warning" id="costo-total">{{ costo_total }}</div>

            <h4>An√°lisis de Sensibilidad:</h4>
            <div id="analisis" class="alert alert-success">Esperando an√°lisis...</div>

            <button class="btn btn-primary mt-2 w-100" onclick="realizarAnalisis()">üìä Generar An√°lisis</button>

            <script>
                function mostrarSolucion() {
                    let solucionRaw = document.getElementById("solucion").getAttribute("data-json");
                    let parsedData;
            
                    try {
                        parsedData = JSON.parse(solucionRaw);
                    } catch (error) {
                        console.error("‚ùå Error al parsear la soluci√≥n:", error);
                        document.getElementById("solucion").innerHTML = "<p class='text-danger'>Error al procesar la soluci√≥n.</p>";
                        return;
                    }
            
                    let formattedSolucion = "<ul>";
                    for (let destino in parsedData) {
                        formattedSolucion += `<li><strong>${destino}:</strong> <ul>`;
                        for (let proveedor in parsedData[destino]) {
                            formattedSolucion += `<li>${proveedor}: ${parsedData[destino][proveedor]}</li>`;
                        }
                        formattedSolucion += "</ul></li>";
                    }
                    formattedSolucion += "</ul>";
            
                    document.getElementById("solucion").innerHTML = formattedSolucion;
                }
            
                async function realizarAnalisis() {
                    let solucionRaw = document.getElementById("solucion").getAttribute("data-json");
                    let costoTotal = document.getElementById("costo-total").innerText.trim();
                    let contexto = document.getElementById("contexto").value.trim();
            
                    if (!contexto) {
                        alert("‚ö†Ô∏è Por favor, ingrese el contexto del problema.");
                        return;
                    }
            
                    console.log("üì§ Enviando datos...");
                    console.log("üìå Contexto:", contexto);
                    console.log("üìå Soluci√≥n:", solucionRaw);
                    console.log("üìå Costo Total:", costoTotal);
            
                    try {
                        let response = await fetch("{{ url_for('transporte_solver_web.procesar_analisis') }}", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                contexto: contexto, 
                                solucion: JSON.parse(solucionRaw),  
                                costo_total: costoTotal 
                            })
                        });
            
                        let data = await response.json();
                        console.log("üì• Respuesta del servidor:", data);
            
                        if (data.status === "success") {
                            document.getElementById("analisis").innerHTML = `<p>${data.analisis.replace(/\n/g, "<br>")}</p>`;
                        } else {
                            document.getElementById("analisis").innerHTML = "<p class='text-danger'>‚ùå Error en el an√°lisis.</p>";
                        }
                    } catch (error) {
                        document.getElementById("analisis").innerHTML = "<p class='text-danger'>‚ùå Error al procesar el an√°lisis.</p>";
                        console.error("‚ùå Error en la petici√≥n al backend:", error);
                    }
                }
            
                window.onload = mostrarSolucion;
            </script>

            <div class="text-center mt-3">
                <a href="/" class="btn btn-outline-secondary">üè† Regresar al Men√∫ Principal</a>
            </div>
        </div>
    </div>
</body>
</html>
